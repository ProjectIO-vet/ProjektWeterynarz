<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Doktora – BKRJ Vet</title>
  <style>
    body { margin:0; font-family:Arial,sans-serif; }
    header { background:#4caf50; color:#fff; padding:15px; display:flex; justify-content:space-between; align-items:center; }
    nav a, nav button { color:#fff; background:none; border:none; margin-left:10px; cursor:pointer; text-decoration:none; }
    nav a:hover, nav button:hover { text-decoration:underline; }
    .container { max-width:1000px; margin:40px auto; padding:0 20px; }
    .hidden { display:none; }
    .error { color:red; text-align:center; margin-top:50px; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:left; }
    th { background:#f4f4f4; }
    .cancel-btn { padding:4px 8px; background:#d9534f; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    .cancel-btn:hover { background:#c9302c; }
    #appt-status { margin-top:10px; font-weight:bold; }
  </style>
</head>
<body>
  <header>
    <h1>Panel Doktora</h1>
    <nav>
      <a href="index.html">Strona główna</a>
      <button id="logoutBtn">Wyloguj</button>
    </nav>
  </header>

  <div id="loading" class="container">
    <p>Sprawdzanie uprawnień…</p>
  </div>

  <div id="doctorContent" class="container hidden">
    <h2>Witaj, Doktorze!</h2>
    <section id="doctor-appointments">
      <h3>Moje wizyty</h3>
      <table id="appointments-table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Godzina</th>
            <th>Zwierzak</th>
            <th>Rodzaj wizyty</th>
            <th>Akcja</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p id="appt-status"></p>
    </section>
  </div>

  <div id="errorMessage" class="container error hidden">
    <p>Brak dostępu. Tylko lekarze mogą wchodzić na tę stronę.</p>
    <a href="index.html">← Powrót do strony głównej</a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      getDocs,
      deleteDoc,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCZoVVfUPSyS7zELBqEsLNYuVdBqfSq-BE",
      authDomain: "bkrj-vet.firebaseapp.com",
      projectId: "bkrj-vet",
      storageBucket: "bkrj-vet.firebasestorage.app",
      messagingSenderId: "289704325759",
      appId: "1:289704325759:web:844ebae6cff71bbf40854a",
      measurementId: "G-EH0EC8NKXC"
    };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const loadingEl = document.getElementById("loading");
    const doctorEl  = document.getElementById("doctorContent");
    const errorEl   = document.getElementById("errorMessage");
    const logoutBtn = document.getElementById("logoutBtn");

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

    onAuthStateChanged(auth, async user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      // Pobierz rolę z Firestore
      const uSnap = await getDoc(doc(db, "users", user.uid));
      const profile = uSnap.data() || {};

      loadingEl.classList.add("hidden");
      if (profile.role === "doctor") {
        doctorEl.classList.remove("hidden");
        initDoctorAppointments();
      } else {
        errorEl.classList.remove("hidden");
      }
    });

    async function initDoctorAppointments() {
      const tableBody  = document.querySelector("#appointments-table tbody");
      const statusP    = document.getElementById("appt-status");
      const doctorId   = auth.currentUser.uid;
      const bookingsRef = collection(db, "users", doctorId, "bookings");

      async function loadAppointments() {
        tableBody.innerHTML = "";
        statusP.textContent = "";

        // Pobierz posortowane wizyty
        const q = query(
          bookingsRef,
          orderBy("date",  "asc"),
          orderBy("hour",  "asc")
        );
        const snap = await getDocs(q);

        snap.forEach(docSnap => {
          const b = docSnap.data();
          const id = docSnap.id;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${b.date}</td>
            <td>${b.hour} – ${b.endHour}</td>
            <td>${b.petName} (${b.petSpecies})</td>
            <td>${b.visitType}</td>
            <td>
              <button class="cancel-btn" data-id="${id}" data-user="${b.userId}">
                Anuluj
              </button>
            </td>
          `;
          tableBody.append(tr);
        });
      }

      tableBody.addEventListener("click", async e => {
        if (!e.target.matches(".cancel-btn")) return;
        const bookingId = e.target.dataset.id;
        const clientId  = e.target.dataset.user;
        if (!confirm("Na pewno anulować tę wizytę?")) return;
        try {
          // usuń wizytę doktora
          await deleteDoc(doc(db, "users", doctorId, "bookings", bookingId));
          // usuń wizytę klienta
          await deleteDoc(doc(db, "users", clientId, "bookings", bookingId));
          statusP.textContent = "Wizyta anulowana.";
          statusP.style.color = "green";
          await loadAppointments();
        } catch (err) {
          console.error(err);
          statusP.textContent = "Błąd anulowania: " + err.message;
          statusP.style.color = "red";
        }
      });

      await loadAppointments();
    }
  </script>
</body>
</html>
