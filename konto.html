<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Moje Konto | BKRJ Vet</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      line-height: 1.6;
      background: #f7f7f7;
      color: #333;
    }
    header {
      background: #4CAF50;
      color: #fff;
      padding: 20px 0;
    }
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    .navbar a {
      color: #fff;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }
    .navbar a:hover {
      text-decoration: underline;
    }
    .user-greeting {
      color: #fff;
      margin-right: 15px;
      font-size: 14px;
    }
    .logout-btn {
      background: #d9534f;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-left: 10px;
    }
    .logout-btn:hover {
      background: #c9302c;
    }
    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 0 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding-bottom: 40px;
    }
    .header-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    h2.section-title {
      color: #4CAF50;
      margin-top: 30px;
      margin-bottom: 10px;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 5px;
    }
    form {
      margin-top: 10px;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    input[type="text"],
    input[type="tel"],
    input[type="email"],
    input[type="number"],
    select {
      width: 100%;
      padding: 8px 10px;
      margin-top: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 1rem;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      background: #4CAF50;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
    .error, .success {
      margin-top: 12px;
      padding: 8px;
      border-radius: 4px;
      display: none;
    }
    .error {
      color: #d8000c;
      background: #ffd2d2;
    }
    .success {
      color: #4F8A10;
      background: #DFF2BF;
    }
    .pets-list {
      list-style: none;
      padding: 0;
      margin-top: 10px;
    }
    .pets-list li {
      background: #f1f1f1;
      margin-bottom: 8px;
      padding: 10px;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .pets-list li span {
      display: inline-block;
    }
    .delete-pet {
      background: #d9534f;
      color: #fff;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .delete-pet:hover {
      background: #c9302c;
    }
  </style>
</head>
<body>
  <!-- Nagłówek taki sam jak na stronie głównej -->
  <header>
    <div class="navbar">
      <div class="logo"><h1>BKRJ Vet</h1></div>
      <nav id="nav-bar">
        <a href="index.html">Strona główna</a>
        <a href="umow-wizyte.html" id="nav-umow">Umów wizytę</a>
        <a href="rejestracja.html" id="nav-rejestracja">Rejestracja</a>
        <a href="login.html" id="nav-logowanie">Logowanie</a>
        <a href="#about">O nas</a>
        <a href="#contact">Kontakt</a>
        <span id="user-greeting" class="user-greeting" style="display: none;"></span>
        <a href="konto.html" id="nav-konto" style="display: none;">Moje Konto</a>
      </nav>
    </div>
  </header>

  <div class="container">
    <div class="header-actions">
      <div>
        <span id="user-greeting-top" style="font-size: 16px; font-weight: bold;"></span>
      </div>
      <button id="logout-button" class="logout-btn">Wyloguj</button>
    </div>

    <h2 class="section-title">Mój Profil</h2>
    <!-- Formularz danych kontaktowych -->
    <form id="profile-form">
      <label for="firstName">Imię:</label>
      <input type="text" id="firstName" placeholder="Wpisz swoje imię" required />

      <label for="lastName">Nazwisko:</label>
      <input type="text" id="lastName" placeholder="Wpisz swoje nazwisko" required />

      <label for="phone">Numer telefonu:</label>
      <input type="tel" id="phone" placeholder="Wpisz numer telefonu" required />

      <label for="address">Adres (ulica i numer):</label>
      <input type="text" id="address" placeholder="Wpisz adres (ulica i numer)" />

      <label for="city">Miasto:</label>
      <input type="text" id="city" placeholder="Wpisz miasto" />

      <button type="submit">Zapisz dane kontaktowe</button>
      <div id="profile-success" class="success">Dane kontaktowe zapisane pomyślnie.</div>
      <div id="profile-error" class="error">Wystąpił błąd podczas zapisu danych.</div>
    </form>

    <h2 class="section-title">Moje Zwierzaki</h2>
    <!-- Lista zwierzaków użytkownika -->
    <ul id="pets-list" class="pets-list">
      <!-- Tutaj będą wstawiane elementy listy -->
    </ul>

    <!-- Formularz dodawania nowego zwierzaka -->
    <form id="add-pet-form">
      <label for="petName">Imię zwierzaka:</label>
      <input type="text" id="petName" placeholder="Wpisz imię zwierzaka" required />

      <label for="petSpecies">Gatunek:</label>
      <select id="petSpecies" required>
        <option value="" disabled selected>Wybierz gatunek</option>
        <option value="Pies">Pies</option>
        <option value="Kot">Kot</option>
        <option value="Chomik szczękacz">Chomik szczękacz</option>
        <option value="Królik ninja">Królik ninja</option>
        <option value="Papuga rozrabiara">Papuga rozrabiara</option>
        <option value="Koza skoczek">Koza skoczek</option>
        <option value="Jeż jeżyk">Jeż jeżyk</option>
        <option value="Wąż boa">Wąż boa</option>
        <option value="Krokodyl egipski">Krokodyl egipski</option>
      </select>

      <label for="petSize">Rozmiar zwierzaka:</label>
      <select id="petSize" required>
        <option value="" disabled selected>Wybierz rozmiar</option>
        <option value="Mały">Mały</option>
        <option value="Średni">Średni</option>
        <option value="Duży">Duży</option>
      </select>

      <label for="petAge">Wiek (w latach):</label>
      <input type="number" id="petAge" min="0" step="1" placeholder="Wpisz wiek" required />

      <button type="submit">Dodaj zwierzaka</button>
      <div id="pet-success" class="success">Zwierzak dodany pomyślnie.</div>
      <div id="pet-error" class="error">Wystąpił błąd podczas dodawania zwierzaka.</div>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc,
      collection,
      addDoc,
      query,
      where,
      getDocs,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MSG_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const userGreeting = document.getElementById("user-greeting");
    const userGreetingTop = document.getElementById("user-greeting-top");
    const logoutButton = document.getElementById("logout-button");

    const profileForm = document.getElementById("profile-form");
    const profileSuccess = document.getElementById("profile-success");
    const profileError = document.getElementById("profile-error");

    const addPetForm = document.getElementById("add-pet-form");
    const petSuccess = document.getElementById("pet-success");
    const petError = document.getElementById("pet-error");

    const petsList = document.getElementById("pets-list");

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userGreeting.style.display = "inline";
        userGreeting.textContent = `Witaj, ${user.email}`;
        userGreetingTop.textContent = `Witaj, ${user.email}`;

        // Załaduj profil użytkownika i wypełnij formularz
        const profileDocRef = doc(db, "users", user.uid);
        const profileSnap = await getDoc(profileDocRef);
        if (profileSnap.exists()) {
          const profileData = profileSnap.data();
          document.getElementById("firstName").value = profileData.firstName || "";
          document.getElementById("lastName").value = profileData.lastName || "";
          document.getElementById("phone").value = profileData.phone || "";
          document.getElementById("address").value = profileData.address || "";
          document.getElementById("city").value = profileData.city || "";
        }

        // Załaduj zwierzaki użytkownika
        await loadUserPets(user.uid);

      } else {
        userGreeting.style.display = "none";
        userGreetingTop.textContent = "";
        // Jeśli użytkownik nie jest zalogowany, przekieruj go na stronę logowania
        window.location.href = "login.html";
      }
    });

    logoutButton.addEventListener("click", () => {
      signOut(auth)
        .then(() => {
          window.location.href = "login.html";
        })
        .catch((error) => {
          alert("Błąd podczas wylogowywania: " + error.message);
        });
    });

    profileForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      profileSuccess.style.display = "none";
      profileError.style.display = "none";

      const user = auth.currentUser;
      if (!user) return;

      const firstName = document.getElementById("firstName").value.trim();
      const lastName = document.getElementById("lastName").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const address = document.getElementById("address").value.trim();
      const city = document.getElementById("city").value.trim();

      try {
        await updateDoc(doc(db, "users", user.uid), {
          firstName,
          lastName,
          phone,
          address,
          city
        });
        profileSuccess.style.display = "block";
      } catch (error) {
        profileError.style.display = "block";
        console.error("Błąd podczas zapisywania profilu:", error);
      }
    });

    addPetForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      petSuccess.style.display = "none";
      petError.style.display = "none";

      const user = auth.currentUser;
      if (!user) return;

      const petName = document.getElementById("petName").value.trim();
      const petSpecies = document.getElementById("petSpecies").value;
      const petSize = document.getElementById("petSize").value;
      const petAge = parseInt(document.getElementById("petAge").value, 10);

      try {
        await addDoc(collection(db, "pets"), {
          ownerId: user.uid,
          name: petName,
          species: petSpecies,
          size: petSize,
          age: petAge
        });
        petSuccess.style.display = "block";
        addPetForm.reset();
        await loadUserPets(user.uid);
      } catch (error) {
        petError.style.display = "block";
        console.error("Błąd podczas dodawania zwierzaka:", error);
      }
    });

    async function loadUserPets(userId) {
      petsList.innerHTML = "";
      const petsQuery = query(collection(db, "pets"), where("ownerId", "==", userId));
      const querySnapshot = await getDocs(petsQuery);

      querySnapshot.forEach((docSnap) => {
        const petData = docSnap.data();
        const li = document.createElement("li");

        const infoSpan = document.createElement("span");
        infoSpan.textContent = `${petData.name} • ${petData.species} • ${petData.size} • ${petData.age} ${petData.age === 1 ? "rok" : "lata"}`;

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Usuń";
        deleteBtn.classList.add("delete-pet");
        deleteBtn.addEventListener("click", async () => {
          if (confirm(`Czy na pewno chcesz usunąć zwierzaka ${petData.name}?`)) {
            try {
              await deleteDoc(doc(db, "pets", docSnap.id));
              await loadUserPets(userId);
            } catch (error) {
              alert("Błąd podczas usuwania zwierzaka: " + error.message);
            }
          }
        });

        li.appendChild(infoSpan);
        li.appendChild(deleteBtn);
        petsList.appendChild(li);
      });
    }
  </script>
</body>
</html>
