<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Moje Konto | BKRJ Vet</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      line-height: 1.6;
      background: #f7f7f7;
      color: #333;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 5px;
      color: white;
      background-color: #4CAF50;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      z-index: 1000;
      transition: all 0.5s ease;
      opacity: 0;
      transform: translateY(-100px);
      visibility: hidden;
    }
    
    .notification.show {
      opacity: 1;
      transform: translateY(0);
      visibility: visible;
    }
    
    .notification.error {
      background-color: #d9534f;
    }
    header {
      background: #4CAF50;
      color: #fff;
      padding: 20px 0;
    }
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    .navbar a {
      color: #fff;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }
    .navbar a:hover {
      text-decoration: underline;
    }
    .user-greeting {
      color: #fff;
      margin-right: 15px;
      font-size: 14px;
    }
    .logout-btn {
      background-color: #d9534f;
      color: white;
      border: none;
      border-radius: 20px;
      margin-left: 15px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
      padding: 12px 24px;
      font-size: 16px;
    }
    
    .logout-btn:hover {
      background-color: #c9302c;
    }
    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 0 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding-bottom: 40px;
    }
    .header-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    h2.section-title {
      color: #4CAF50;
      margin-top: 30px;
      margin-bottom: 10px;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 5px;
    }
    form {
      margin-top: 10px;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    input[type="text"],
    input[type="tel"],
    input[type="email"],
    input[type="number"],
    select {
      width: 100%;
      padding: 8px 10px;
      margin-top: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 1rem;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      background: #4CAF50;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
    .error, .success {
      margin-top: 12px;
      padding: 8px;
      border-radius: 4px;
      display: none;
    }
    .error {
      color: #d8000c;
      background: #ffd2d2;
    }
    .success {
      color: #4F8A10;
      background: #DFF2BF;
    }
    .pets-list {
      list-style: none;
      padding: 0;
      margin-top: 10px;
    }
    .pets-list li {
      background: #f1f1f1;
      margin-bottom: 8px;
      padding: 10px;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .pets-list li span {
      display: inline-block;
    }
    .delete-pet {
      background: #d9534f;
      color: #fff;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .delete-pet:hover {
      background: #c9302c;
    }
  </style>
</head>
<body>
  <div id="notification" class="notification">
    <span id="notification-message"></span>
  </div>
  
  <header>
    <div class="navbar">
      <div class="logo"><h1>BKRJ Vet</h1></div>
      <nav id="nav-bar">
        <a href="index.html">Strona główna</a>
        <a href="umow-wizyte.html" id="nav-umow">Umów wizytę</a>
        <a href="#about">O nas</a>
        <a href="#contact">Kontakt</a>
        <span id="user-greeting" class="user-greeting" style="display: none;"></span>
        <a href="konto.html" id="nav-konto" style="display: none;">Moje Konto</a>
        <button id="logout-button" class="logout-btn" style="margin: 0; padding: 6px 12px;">Wyloguj</button>
      </nav>
    </div>
  </header>

  <div class="container">
    <h2 class="section-title">Mój Profil</h2>
    <form id="profile-form">
      <label for="firstName">Imię:</label>
      <input type="text" id="firstName" placeholder="Wpisz swoje imię" required />

      <label for="lastName">Nazwisko:</label>
      <input type="text" id="lastName" placeholder="Wpisz swoje nazwisko" required />

      <label for="phone">Numer telefonu:</label>
      <input type="tel" id="phone" placeholder="Wpisz numer telefonu" required />

      <label for="address">Adres (ulica i numer):</label>
      <input type="text" id="address" placeholder="Wpisz adres (ulica i numer)" />

      <label for="city">Miasto:</label>
      <input type="text" id="city" placeholder="Wpisz miasto" />

      <button type="submit">Zapisz dane kontaktowe</button>
      <div id="profile-success" class="success">Dane kontaktowe zapisane pomyślnie.</div>
      <div id="profile-error" class="error">Wystąpił błąd podczas zapisu danych.</div>
    </form>

    <h2 class="section-title">Moje Zwierzaki</h2>
    <ul id="pets-list" class="pets-list">
      <!-- Tutaj będą wstawiane elementy listy -->
    </ul>

    <form id="add-pet-form">
      <label for="petName">Imię zwierzaka:</label>
      <input type="text" id="petName" placeholder="Wpisz imię zwierzaka" required />

      <label for="petSpecies">Gatunek:</label>
      <select id="petSpecies" required>
        <option value="" disabled selected>Wybierz gatunek</option>
        <option value="Pies">Pies</option>
        <option value="Kot">Kot</option>
        <option value="Chomik szczękacz">Chomik szczękacz</option>
        <option value="Królik ninja">Królik ninja</option>
        <option value="Papuga rozrabiara">Papuga rozrabiara</option>
        <option value="Koza skoczek">Koza skoczek</option>
        <option value="Jeż jeżyk">Jeż jeżyk</option>
        <option value="Wąż boa">Wąż boa</option>
        <option value="Krokodyl egipski">Krokodyl egipski</option>
      </select>

      <label for="petSize">Rozmiar zwierzaka:</label>
      <select id="petSize" required>
        <option value="" disabled selected>Wybierz rozmiar</option>
        <option value="Mały">Mały</option>
        <option value="Średni">Średni</option>
        <option value="Duży">Duży</option>
      </select>

      <label for="petAge">Wiek (w latach):</label>
      <input type="number" id="petAge" min="0" step="1" placeholder="Wpisz wiek" required />

      <button type="submit">Dodaj zwierzaka</button>
      <div id="pet-success" class="success">Zwierzak dodany pomyślnie.</div>
      <div id="pet-error" class="error">Wystąpił błąd podczas dodawania zwierzaka.</div>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc,
      collection,
      addDoc,
      getDocs,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCZoVVfUPSyS7zELBqEsLNYuVdBqfSq-BE",
      authDomain: "bkrj-vet.firebaseapp.com",
      projectId: "bkrj-vet",
      storageBucket: "bkrj-vet.appspot.com",
      messagingSenderId: "289704325759",
      appId: "1:289704325759:web:844ebae6cff71bbf40854a",
      measurementId: "G-EH0EC8NKXC"
    };
    const app   = initializeApp(firebaseConfig);
    const auth  = getAuth(app);
    const db    = getFirestore(app);

    const linkRejestracja    = document.getElementById('nav-rejestracja');
    const linkLogowanie      = document.getElementById('nav-logowanie');
    const linkKonto          = document.getElementById('nav-konto');
    const userGreeting       = document.getElementById('user-greeting');
    const userGreetingTop    = document.getElementById('user-greeting-top');
    const logoutButton       = document.getElementById('logout-button');

    const profileForm       = document.getElementById('profile-form');
    const firstNameInput    = document.getElementById('firstName');
    const lastNameInput     = document.getElementById('lastName');
    const phoneInput        = document.getElementById('phone');
    const addressInput      = document.getElementById('address');
    const cityInput         = document.getElementById('city');
    const profileSuccess    = document.getElementById('profile-success');
    const profileError      = document.getElementById('profile-error');

    const petsList          = document.getElementById('pets-list');
    const addPetForm        = document.getElementById('add-pet-form');
    const petNameInput      = document.getElementById('petName');
    const petSpeciesSelect  = document.getElementById('petSpecies');
    const petSizeSelect     = document.getElementById('petSize');
    const petAgeInput       = document.getElementById('petAge');
    const petSuccess        = document.getElementById('pet-success');
    const petError          = document.getElementById('pet-error');

    let currentUserUid = null;

    // Funkcja do wyświetlania powiadomień
    window.showNotification = function(message, isError = false) {
      const notification = document.getElementById('notification');
      const messageElement = document.getElementById('notification-message');
      
      notification.className = isError ? 'notification error' : 'notification';
      messageElement.textContent = message;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      
      currentUserUid = user.uid;
      userGreeting.textContent = `Witaj, ${user.email}`;
      userGreeting.style.display = 'inline-block';
      userGreetingTop.textContent = `Witaj, ${user.email}`;
      linkRejestracja.style.display = 'none';
      linkLogowanie.style.display   = 'none';
      linkKonto.style.display       = 'inline-block';

      await loadUserProfile();
      await loadUserPets();
      
      // Sprawdź parametry URL po załadowaniu strony
      const urlParams = new URLSearchParams(window.location.search);
      const notificationMessage = urlParams.get('notification');
      const isError = urlParams.get('isError') === 'true';
      
      if (notificationMessage) {
        showNotification(decodeURIComponent(notificationMessage), isError);
        // Usuń parametry z URL, aby nie pokazywać powiadomienia przy odświeżeniu
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    });

    logoutButton.addEventListener('click', async () => {
      try {
        await signOut(auth);
        // Przekieruj z parametrami
        window.location.href = "index.html?notification=Zostałeś%20pomyślnie%20wylogowany!&isError=false";
      } catch (error) {
        console.error('Błąd wylogowania:', error);
        window.location.href = "index.html?notification=Wystąpił%20błąd%20podczas%20wylogowania&isError=true";
      }
    });

    async function loadUserProfile() {
      try {
        const userDocRef = doc(db, "users", currentUserUid);
        const userSnap   = await getDoc(userDocRef);
        if (userSnap.exists()) {
          const data = userSnap.data();
          firstNameInput.value = data.firstName || "";
          lastNameInput.value  = data.lastName  || "";
          phoneInput.value     = data.phone     || "";
          addressInput.value   = data.address   || "";
          cityInput.value      = data.city      || "";
        }
      } catch (err) {
        console.error("Błąd podczas pobierania profilu:", err);
      }
    }

    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      profileSuccess.style.display = 'none';
      profileError.style.display   = 'none';

      const profileRef = doc(db, "users", currentUserUid);
      const profileData = {
        firstName: firstNameInput.value.trim(),
        lastName:  lastNameInput.value.trim(),
        phone:     phoneInput.value.trim(),
        address:   addressInput.value.trim(),
        city:      cityInput.value.trim()
      };
      try {
        await updateDoc(profileRef, profileData);
        showNotification("Dane kontaktowe zapisane pomyślnie!");
      } catch (err) {
        console.error("Błąd przy zapisie profilu:", err);
        showNotification("Wystąpił błąd podczas zapisu danych", true);
      }
    });

    async function loadUserPets() {
      petsList.innerHTML = "";
      try {
        const petsColRef = collection(db, "users", currentUserUid, "pets");
        const petsSnapshot = await getDocs(petsColRef);
        petsSnapshot.forEach(docSnap => {
          const petData = docSnap.data();
          const li = document.createElement("li");

          const infoSpan = document.createElement("span");
          infoSpan.textContent = `${petData.name} • ${petData.species} • ${petData.size} • ${petData.age} ${petData.age == 1 ? "rok" : "lata"}`;

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "Usuń";
          deleteBtn.className = "delete-pet";
          deleteBtn.addEventListener("click", () => deletePet(docSnap.id));

          li.appendChild(infoSpan);
          li.appendChild(deleteBtn);
          petsList.appendChild(li);
        });
      } catch (err) {
        console.error("Błąd podczas wczytywania zwierzaków:", err);
      }
    }

    addPetForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      petSuccess.style.display = 'none';
      petError.style.display   = 'none';

      const species = petSpeciesSelect.value;
      const size = petSizeSelect.value;
      const newPet = {
        name:     petNameInput.value.trim(),
        species:  species,
        size:     size,
        age:      parseInt(petAgeInput.value, 10)
      };

      try {
        const petsColRef = collection(db, "users", currentUserUid, "pets");
        await addDoc(petsColRef, newPet);
        await loadUserPets();
        showNotification("Zwierzak dodany pomyślnie!");
        addPetForm.reset();
      } catch (err) {
        console.error("Błąd przy dodawaniu zwierzaka:", err);
        showNotification("Wystąpił błąd podczas dodawania zwierzaka", true);
      }
    });

    async function deletePet(petId) {
      try {
        const petDocRef = doc(db, "users", currentUserUid, "pets", petId);
        await deleteDoc(petDocRef);
        await loadUserPets();
        showNotification("Zwierzak został usunięty");
      } catch (err) {
        console.error("Błąd przy usuwaniu zwierzaka:", err);
        showNotification("Wystąpił błąd podczas usuwania zwierzaka", true);
      }
    }
  </script>
</body>
</html>
